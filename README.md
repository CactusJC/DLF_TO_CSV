# DLF to CSV Conversion Tools

This document describes the tools for converting Divesoft DLF files to CSV format.

## Components

- `tools/dlf_parser_helper`: A C helper program that uses `libdivecomputer` to parse a `.dlf` file and output a JSON representation of the dive data.
- `tools/libdc_json_to_csv.py`: A Python script that uses the C helper to convert a `.dlf` file to a CSV file.

## Building

To build the C helper, you need to have `libdivecomputer` installed on your system. If it's not installed, you can clone and build it as follows:

```bash
# Clone libdivecomputer
git clone https://github.com/libdivecomputer/libdivecomputer.git /tmp/libdivecomputer

# Build and install
cd /tmp/libdivecomputer
autoreconf --install
./configure
make
sudo make install
```

Once `libdivecomputer` is installed, you can build the C helper by running `make` in the `tools` directory:

```bash
make -C tools
```

## Usage

### C Helper (`dlf_parser_helper`)

The C helper takes a `.dlf` file as input and outputs JSON to standard output.

**Usage:**
```bash
./tools/dlf_parser_helper <path_to.dlf>
```

**Example:**
```bash
# Make sure to set LD_LIBRARY_PATH if libdivecomputer is not in a standard location
export LD_LIBRARY_PATH=/usr/local/lib
./tools/dlf_parser_helper tests/00000002.dlf > tests/out.json
```

### Python Script (`libdc_json_to_csv.py`)

The Python script is a wrapper around the C helper that converts the JSON output to a CSV file.

**Usage:**
```bash
python3 tools/libdc_json_to_csv.py --helper <path_to_helper> --out <output.csv> <input.dlf>
```

**Example:**
```bash
python3 tools/libdc_json_to_csv.py --helper ./tools/dlf_parser_helper --out tests/out.csv tests/00000002.dlf
```

## Testing

The automated test script `tools/tests/test_conversion.py` verifies the correctness of the conversion pipeline. It compares the output of the C helper with a reference XML file generated by `dctool`.

To run the tests, execute the following command from the project root:

```bash
python3 tools/tests/test_conversion.py
```

## Troubleshooting

- **`dlf_parser_helper: error while loading shared libraries: libdivecomputer.so.0`**: This error means the dynamic linker cannot find the `libdivecomputer` shared library. You need to add the installation path of the library (e.g., `/usr/local/lib`) to the `LD_LIBRARY_PATH` environment variable:
  ```bash
  export LD_LIBRARY_PATH=/usr/local/lib
  ```
- **Compilation errors**: Make sure you have `pkg-config` installed and that it can find `libdivecomputer.pc`. If `libdivecomputer` is installed in a non-standard prefix, you may need to set the `PKG_CONFIG_PATH` environment variable.
  ```bash
  export PKG_CONFIG_PATH=/path/to/libdivecomputer/pkgconfig
  ```

## Licensing

The C helper `dlf_parser_helper` is dynamically linked against the `libdivecomputer` library. `libdivecomputer` is licensed under the GNU Lesser General Public License (LGPL) version 2.1.

- **`libdivecomputer` website:** [http://www.libdivecomputer.org/](http://www.libdivecomputer.org/)
- **`libdivecomputer` source code:** [https://github.com/libdivecomputer/libdivecomputer](https://github.com/libdivecomputer/libdivecomputer)

The code in this repository is licensed under the terms of the LICENSE file in the repository root.
